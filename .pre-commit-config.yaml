# Copyright (c) 2022 Graphcore Ltd. All rights reserved.
---
exclude: |
    (?x)^(
        build_scripts/.*|
        willow/include/popart/vendored/.*|
        .arclint|
        .arcconfig|
        .buildignore|
        .clang-format|
        .style.yapf|
        .*Doxyfile.in|
        .*LICENSE|
        .*.drawio|
        .*.json|
        .*.md|
        .*.png|
        .*.pdf|
        .*.rst
    )$
repos:
    - repo: local
      hooks:
          - id: version-checker
            name: Version checker
            description: Ensures that the correct version of the linters are used.
            entry: python3 -m scripts.lint.linters.check_versions
            language: python
            exclude: ".*"  # Does not run on files
            always_run: true
            fail_fast: true
            additional_dependencies:
                - pyyaml
          - id: copyright-linter
            name: Copyright linter
            description: Ensures that files have the proper copyright line.
            entry: python3 -m scripts.lint.linters.copyright_linter
            language: python
            exclude: tests/integration/operators_test/rnn_helper.py
            additional_dependencies:
                # dataclasses was introduced in Python 3.7
                # For python 3.6 it therefore needs to be added as a dependency
                - dataclasses
          - id: popart-test-linter
            name: PopART test-linter
            description: |
              checks that pytest test files have a corresponding
              `add_popart_py_unit_test` entry in a neighbouring CMakeLists.txt
              file
            entry: tests/popart_test_linter/check_test_has_cmake_entry.py
            language: python
            files: .*.py
            exclude: |
                (?x)^(
                    docs/user_guide/files/tests/test_popart_doc_examples.py|
                    docs/popxl/files/tests/test_popxl_doc_examples.py|
                    docs/popxl/files/mnist.py|
                    tests/linters/.*
                )$
          # Note: pylint to be run locally:
          # https://pylint.pycqa.org/en/latest/user_guide/pre-commit-integration.html
          - id: pylint
            name: pylint
            entry: pylint
            language: system
            types: [python]
            args:
              [
                --rcfile=scripts/lint/linters/pylintrc
              ]
    -   repo: https://github.com/pre-commit/pre-commit-hooks
        rev: v2.3.0
        hooks:
        -   id: check-yaml
        -   id: check-json
        -   id: check-merge-conflict
        -   id: debug-statements
        -   id: end-of-file-fixer
        -   id: mixed-line-ending
        -   id: trailing-whitespace
    - repo: https://github.com/pre-commit/mirrors-yapf
      rev: v0.27.0
      hooks:
          - id: yapf
    -   repo: https://github.com/pycqa/pydocstyle
        rev: 6.1.1
        hooks:
        -   id: pydocstyle
            # Tests are currently emitting a lot of errors, will be fixed at a later stage
            exclude: tests/
            args:
              # See explanation of error codes at http://www.pydocstyle.org/en/6.1.1/error_codes.html
              # By using select, most checking is ignored
              # This can be checked when enough errors has been fixed
              - |-
                --select=
                D400,
                D401
    - repo: https://github.com/pocc/pre-commit-hooks
      rev: v1.3.5
      hooks:
          # Install with pip3 install clang-format==9.0.0
          - id: clang-format
            exclude: willow/include/popart/vendored/
            args: [
                -i,  # Fix inplace
                --style=file  # Use .clang-tidy
            ]
    #      - id: clang-tidy
    #      - id: oclint
    #      - id: uncrustify
          - id: cppcheck
            args: [
                --inline-suppr,
                --suppressions-list=scripts/lint/linters/cppcheck-suppressions-list.txt
            ]
    #      - id: cpplint
    - repo: local
      hooks:
          # The clone linter should run after the format linters so that it only works on formatted files
          - id: clone-linter
            name: Clone linter
            description: Ensures that all Ops implements a clone().
            entry: python3 -m scripts.lint.linters.clone_linter
            language: python
            files: "willow/include/popart/op/.*.hpp"
          # - id: iwyu
          #   language: script
          #   name: Include what you use
          #   types: [c++]
          #   entry: scripts/lint/linters/iwyu/include_what_you_use_linter.sh
          #   exclude: >
          #     (?x)^(
          #         tests/integration/verify_cxx_11_interface/verify_cxx_11_interface.cpp|
          #         willow/include/popart/opidentifier.hpp
          #     )$
